<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>核心环境 Core | MiniExtend</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="一个为迷你世界脚本设计的Lua库">
    
    <link rel="preload" href="/MiniExtendDoc/assets/css/0.styles.fd811cd1.css" as="style"><link rel="preload" href="/MiniExtendDoc/assets/js/app.34877e6c.js" as="script"><link rel="preload" href="/MiniExtendDoc/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/MiniExtendDoc/assets/js/9.8b46da46.js" as="script"><link rel="prefetch" href="/MiniExtendDoc/assets/js/10.151a4c62.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/11.1a4ac75d.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/12.5493479e.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/13.82cf42eb.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/14.67a40162.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/15.300bd2c9.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/16.a4a2400c.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/17.e8a5fd42.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/18.39d3c67a.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/3.40515bec.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/4.94733d25.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/5.2ea06e07.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/7.7124ad08.js"><link rel="prefetch" href="/MiniExtendDoc/assets/js/8.eebc99db.js">
    <link rel="stylesheet" href="/MiniExtendDoc/assets/css/0.styles.fd811cd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MiniExtendDoc/" class="home-link router-link-active"><!----> <span class="site-name">MiniExtend</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MiniExtendDoc/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/MiniExtendDoc/api/" class="nav-link router-link-active">
  API参考
</a></div> <a href="https://github.com/0-0000/MiniExtend" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MiniExtendDoc/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/MiniExtendDoc/api/" class="nav-link router-link-active">
  API参考
</a></div> <a href="https://github.com/0-0000/MiniExtend" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/MiniExtendDoc/guide/" class="sidebar-link">快速上手</a></li><li><a href="/MiniExtendDoc/guide/starter.html" class="sidebar-link">简介与约定</a></li><li><a href="/MiniExtendDoc/guide/environment.html" class="sidebar-link">环境搭建</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MiniExtend API</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/MiniExtendDoc/api/" aria-current="page" class="sidebar-link">简介与约定</a></li><li><a href="/MiniExtendDoc/api/core.html" aria-current="page" class="active sidebar-link">核心环境 Core</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MiniExtendDoc/api/core.html#注意事项" class="sidebar-link">注意事项</a></li></ul></li><li><a href="/MiniExtendDoc/api/log.html" class="sidebar-link">日志管理 Log</a></li><li><a href="/MiniExtendDoc/api/time.html" class="sidebar-link">游戏时间 Time</a></li><li><a href="/MiniExtendDoc/api/object.html" class="sidebar-link">对象管理 Object</a></li><li><a href="/MiniExtendDoc/api/event.html" class="sidebar-link">事件管理 Event</a></li><li><a href="/MiniExtendDoc/api/ui.html" class="sidebar-link">界面管理 UI</a></li></ul></section></li><li><a href="/MiniExtendDoc/changelog.html" class="sidebar-link">更新日志</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="miniextend-core"><a href="#miniextend-core" class="header-anchor">#</a> MiniExtend Core</h1> <p>对应源文件：<code>core.lua</code>。</p> <p>MiniExtend 已尽可能恢复标准 Lua 环境，这意味着你能正常调用那些本来被&quot;删除&quot;的基本函数。</p> <p>以下是相对标准 Lua 环境有所不同的部分（前提是执行了 <code>Env.__init__()</code>）：</p> <h3 id="print"><a href="#print" class="header-anchor">#</a> <code>print</code></h3> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
</code></pre></div><p>由于控制台是不可见的，在脚本中 <code>print()</code> 函数被重定向到日志，MiniExtend 保留了这个更改，虽然进行了重写。</p> <h3 id="loadstring2"><a href="#loadstring2" class="header-anchor">#</a> <code>loadstring2</code></h3> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> <span class="token function">loadstring2</span><span class="token punctuation">(</span>string <span class="token punctuation">[</span><span class="token punctuation">,</span> chuckname<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
</code></pre></div><p>环境为 <code>_GScriptFenv_</code> 的 <code>loadstring()</code> 函数。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>由于 <code>genv[&quot;_GScriptFenv_&quot;]</code> 是脚本环境，因此函数中可以通过 <code>_GScriptFenv_</code> 访问脚本环境，从而进一步访问 MiniExtend 。</p></div> <h3 id="env-init"><a href="#env-init" class="header-anchor">#</a> <code>Env.__init__</code></h3> <p>初始化脚本运行环境。</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">function</span> Env<span class="token punctuation">.</span><span class="token function">__init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
</code></pre></div><p><strong>在每个自定义脚本开头都要最先执行</strong>，不包括 UI 作用域中的 <code>ui_main.lua</code> ，否则可能导致脚本效率降低，出现错误。</p> <p>（实际上就是把脚本对应的函数得环境设为 <code>_GScriptFenv_</code> ）</p> <p>事实上，脚本环境不是真正的 <code>_GScriptFenv_</code> ，而是内部定义的一个表，这个表首先索引游戏 API （例如 Game 、Customui），然后才去索引 <code>_GScriptFenv_</code> 。</p> <p>并且每个脚本都会有不同的这样的环境，因为每个脚本都对应一个函数，而调用脚本即调用该函数，在此之前会设置环境。</p> <h3 id="env-indexapi"><a href="#env-indexapi" class="header-anchor">#</a> <code>Env.indexAPI</code></h3> <p>获取游戏 API 对象，最好使用一个局部变量存储返回值。</p> <p>函数会访问新的 <code>_GScriptFenv_</code> ，但只应用于获取游戏 API 对象。</p> <p>由于 <code>Env.__init__()</code> 把脚本对应的函数的环境设为 <code>_GScriptFenv_</code> ，因此无法直接访问游戏 API ，使用该函数访问游戏 API 。</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">---@param key string 访问的对象名称</span>
<span class="token comment">---@return any 访问结果</span>
<span class="token keyword">function</span> Env<span class="token punctuation">.</span><span class="token function">indexAPI</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">end</span>
</code></pre></div><h3 id="env-index"><a href="#env-index" class="header-anchor">#</a> <code>Env.index</code></h3> <p>使用旧的 <code>_GScriptFenv_</code>（实际上已经不存在）索引全局变量，例如脚本常量、 <code>printtag</code> 、<code>warn</code> 等函数。</p> <p>这等同于以常规方式访问不为游戏 API 的全局变量。</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">---@param key string 索引的键</span>
<span class="token comment">---@return any 引索结果</span>
<span class="token keyword">function</span> Env<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">end</span>
</code></pre></div><h3 id="访问范围表"><a href="#访问范围表" class="header-anchor">#</a> 访问范围表</h3> <table><thead><tr><th style="text-align:center;">方式</th> <th style="text-align:center;"><code>_GScriptFenv_</code> 中的值</th> <th style="text-align:center;">旧的 <code>_GScriptFenv_</code> 可访问的值</th> <th style="text-align:center;">游戏 API</th></tr></thead> <tbody><tr><td style="text-align:center;">直接访问(<code>_G</code>)</td> <td style="text-align:center;">√</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"><code>Env.indexAPI(key)</code></td> <td style="text-align:center;">√</td> <td style="text-align:center;"></td> <td style="text-align:center;">√</td></tr> <tr><td style="text-align:center;"><code>Env.index(key)</code></td> <td style="text-align:center;"></td> <td style="text-align:center;">√</td> <td style="text-align:center;"></td></tr></tbody></table> <h3 id="genv"><a href="#genv" class="header-anchor">#</a> <code>genv</code></h3> <p>该表表示迷你世界脚本内部环境，想知道它包含什么可以遍历它，但要注意该表包含上万个键。</p> <p>开发者编辑的脚本的环境 <code>_GScriptFenv_</code> 不同于 <code>genv</code> ，但 <code>genv[&quot;_GScriptFenv_&quot;]</code> 就等于这个 <code>_GScriptFenv_</code> ，也就是可以以此来通过 <code>genv</code> 访问脚本环境。</p> <p>在使用 <code>Env.__init__()</code> 之前，脚本函数本身的环境是一个特殊的表，它首先控制对游戏 API 的访问，然后才去索引 <code>_GScriptFenv_</code> 。</p> <h3 id="g2"><a href="#g2" class="header-anchor">#</a> <code>_G2</code></h3> <p>在任何可能的环境下(包括 <code>_GScriptFenv_</code> 和 <code>genv</code>)，只要脚本在 <code>core</code> 脚本后运行都可以访问该表，因此可以通过 <code>_G2</code> 来在各个脚本之间交换数据。</p> <p>不要使用 <code>&quot;__MiniExtend__&quot;</code> 开头的变量来作为自己的索引，因为 MiniExtend 使用这种标识符作为索引存储一些变量，你可以遍历 <code>_G2</code> 来确定 MiniExtend 使用了哪些标识符。</p> <h3 id="deepcopy"><a href="#deepcopy" class="header-anchor">#</a> <code>deepcopy</code></h3> <p>深拷贝一个 <code>table</code>。</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">---@param table table 要深拷贝的表</span>
<span class="token comment">---@return table 拷贝结果</span>
<span class="token keyword">function</span> <span class="token function">deepcopy</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token keyword">end</span>
</code></pre></div><p>基本等价于 <code>copy_table(table)</code>，使用它替代 <code>copy_table</code> 。</p> <h2 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h2> <p>迷你世界不是简单的 lua 解释器，有时脚本还会在服务器上运行，因此一些 lua 基本函数可能有歧义。</p> <p>可以近似的认为开发者脚本在服务器上运行，因此 <code>io</code>, <code>package</code>, <code>os.execute</code> 等访问操作系统的函数的行为取决于服务器。</p> <p>对于任何访问系统的函数，例如 <code>io</code>, <code>package</code>, <code>os.execute</code> ，它们大多本是被删除的函数和库，其行为取决于游戏的服务器。</p> <ul><li>在单人模式下，服务器就是玩家的设备。</li> <li>由房主开启的多人游戏，服务器是房主的设备。</li> <li>开发者申请的云服，服务器是迷你世界管理该云服的服务器（未证实）。</li></ul> <div class="custom-block danger"><p class="custom-block-title">某些基本函数可能很危险</p> <p>必须注意这些危险行为，以下是一些例子：</p> <ul><li><code>io.close()</code> 导致<span title="这似乎会使游戏保存，再次打开地图仍是玩法模式，然后继续关闭……所以请使用编辑模式打开">程序突然关闭</span>。</li> <li>在 Windows 下执行 <code>os.execute(&quot;cmd&quot;)</code> ，会弹出一个 cmd 窗口，而且该窗口会<strong>阻塞</strong>程序运行，除非手动关闭。</li></ul></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/8/2023, 8:39:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MiniExtendDoc/api/" class="prev router-link-active">
        简介与约定
      </a></span> <span class="next"><a href="/MiniExtendDoc/api/log.html">
        日志管理 Log
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MiniExtendDoc/assets/js/app.34877e6c.js" defer></script><script src="/MiniExtendDoc/assets/js/2.63c13255.js" defer></script><script src="/MiniExtendDoc/assets/js/9.8b46da46.js" defer></script>
  </body>
</html>
